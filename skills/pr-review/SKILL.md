---
name: pr-review
description: PRレビュー。PR番号・ブランチ名指定時またはレビュー依頼時に使用。現在のセッションとClaude Code別セッションによるマルチ視点レビューでCritical/High/Medium分類の指摘を報告。
context: fork
allowed-tools: Bash(gh:*), Read, Grep, Glob
---

# PRレビュー

## トリガー条件

- PRレビューを依頼された場合
- PR番号またはブランチ名が指定された場合

## 実行手順

### 1. PR情報の取得

```bash
# PR詳細を取得
gh pr view <番号> --json title,body,author,headRefName,baseRefName,files

# diffを取得
gh pr diff <番号> > /tmp/pr-<番号>.diff
```

### 2. PJルールの確認

CLAUDE.mdを読み、以下を把握:
- アーキテクチャルール
- 命名規則
- コーディング規約

### 3. Claude Codeによるレビュー

変更された各ファイルについて:
1. Readツールでファイル全体を読む（diffだけでなく）
2. 既存パターンとの整合性を確認
3. 問題点を特定

### 4. Claude Code別セッションによるレビュー

現在のセッションとは独立した別セッションでレビューを実行し、異なる視点からの指摘を得る。

**利点:**
- 現在のセッションのコンテキストに影響されない客観的なレビュー
- 同じモデルでも別視点からの分析が可能

**重要: タイムアウト対策としてファイル単位で分割実行する**

#### 4.1 変更ファイル一覧の取得

```bash
# 変更ファイル一覧を取得
gh pr view <番号> --json files --jq '.files[].path' > /tmp/pr-<番号>-files.txt
```

#### 4.2 ファイルごとに別セッションでレビュー

各ファイルについて個別にレビューを実行（タイムアウト防止）:

```bash
# 例: 1ファイルずつレビュー
for file in $(cat /tmp/pr-<番号>-files.txt | head -10); do
  gh pr diff <番号> -- "$file" > /tmp/pr-<番号>-${file//\//_}.diff

  claude -p "以下のファイル変更をレビューしてください:

## レビュー観点
- バグ、セキュリティ、パフォーマンス
- 設計の妥当性

## 出力形式
問題があれば Critical/High/Medium に分類。なければ「OK」のみ。

## ファイル: $file
$(cat /tmp/pr-<番号>-${file//\//_}.diff)" --output-format json
done
```

#### 4.3 または並列実行（推奨）

**Taskツールで並列実行**することで効率化:

```
各変更ファイルに対してTaskツール（subagent_type=Bash）を並列起動し、
ファイルごとのレビュー結果を収集する
```

**出力の確認:**
```bash
# 結果はJSON形式で返される
# result フィールドにレビュー内容が含まれる
```

### 5. 結果の統合

現在のセッションと別セッションの両方の指摘を統合し、以下の形式でレポート:

```markdown
# PRレビュー: #<番号>

## 対象
- PR: #<番号> - <タイトル>
- ブランチ: <ブランチ> → <ベース>

## 現在のセッションによる指摘

### Critical
- [指摘内容]

### High
- [指摘内容]

### Medium
- [指摘内容]

## 別セッションによる指摘

### Critical
- [指摘内容]

### High
- [指摘内容]

### Medium
- [指摘内容]

## 統合サマリ

| 観点 | 現在セッション | 別セッション | 統合判断 |
|------|--------------|-------------|---------|
| セキュリティ | OK | OK | OK |
| パフォーマンス | 指摘あり | OK | 要確認 |
| 設計 | OK | 指摘あり | 要確認 |
| テスト | OK | OK | OK |

## 推奨アクション
1. [Critical/Highの指摘への対応]
2. [Mediumの指摘への対応（任意）]

## マージ推奨: [Yes/No/条件付き]
```

## 問題の分類

| 分類 | 説明 | 対応 |
|-----|------|------|
| Critical | バグ、セキュリティ、破壊的変更 | マージ前に必須修正 |
| High | アーキテクチャ違反、テスト不足 | 強く推奨 |
| Medium | 命名、コメント | 改善推奨 |
| Good | 良い実装 | 賞賛 |
