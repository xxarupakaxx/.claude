# 並列調査プロセス

並列実行の特別なケース。共有状態や依存関係なしで調査可能な複数の無関係な失敗がある場合。

## 1. 独立したドメインを特定

何が壊れているかで失敗をグループ化:

- ファイルAのテスト: ツール承認フロー
- ファイルBのテスト: バッチ完了動作
- ファイルCのテスト: 中止機能

各ドメインは独立 - ツール承認を修正しても中止テストには影響しない。

## 2. 焦点を絞ったエージェントタスクを作成

各エージェントに与える:

- **具体的なスコープ:** 1つのテストファイルまたはサブシステム
- **明確な目標:** これらのテストをパスさせる
- **制約:** 他のコードを変更しない
- **期待される出力:** 発見したことと修正したことのサマリー

## 3. 並列でディスパッチ

```typescript
// Claude Code / AI環境で
Task("agent-tool-abort.test.tsの失敗を修正")
Task("batch-completion-behavior.test.tsの失敗を修正")
Task("tool-approval-race-conditions.test.tsの失敗を修正")
// 3つすべてが同時に実行
```

## 4. レビューと統合

エージェントが戻ったら:

- 各サマリーを読む
- 修正が競合しないことを確認
- フルテストスイートを実行
- すべての変更を統合

## エージェントプロンプトの構造

良いエージェントプロンプトは:

1. **焦点を絞っている** - 1つの明確な問題ドメイン
2. **自己完結している** - 問題を理解するために必要なすべてのコンテキスト
3. **出力について具体的** - エージェントは何を返すべきか？

```markdown
src/agents/agent-tool-abort.test.tsの3つの失敗するテストを修正:

1. "should abort tool with partial output capture" - メッセージに'interrupted at'を期待
2. "should handle mixed completed and aborted tools" - 高速ツールが完了ではなく中止された
3. "should properly track pendingToolCount" - 3つの結果を期待しているが0

これらはタイミング/レースコンディションの問題です。タスク:

1. テストファイルを読み、各テストが何を検証しているか理解
2. 根本原因を特定 - タイミングの問題か実際のバグか？
3. 修正方法:
   - 任意のタイムアウトをイベントベースの待機に置き換え
   - 中止実装にバグがあれば修正
   - 変更された動作をテストしている場合はテストの期待値を調整

タイムアウトを増やすだけではダメ - 本当の問題を見つける。

返却: 発見したことと修正したことのサマリー。
```

## よくある間違い

**× 広すぎる:** 「すべてのテストを修正」 - エージェントが迷う
**○ 具体的:** 「agent-tool-abort.test.tsを修正」 - 焦点を絞ったスコープ

**× コンテキストなし:** 「レースコンディションを修正」 - エージェントは場所がわからない
**○ コンテキストあり:** エラーメッセージとテスト名を貼り付ける

**× 制約なし:** エージェントがすべてをリファクタリングするかもしれない
**○ 制約あり:** 「本番コードを変更しない」または「テストのみ修正」

**× 曖昧な出力:** 「修正して」 - 何が変わったかわからない
**○ 具体的:** 「根本原因と変更のサマリーを返す」

## 使用すべきでない場合

**関連する失敗:** 1つを修正すると他も修正されるかもしれない - まず一緒に調査
**フルコンテキストが必要:** 理解にはシステム全体を見る必要がある
**探索的デバッグ:** 何が壊れているかまだわからない
**共有状態:** エージェントが干渉する（同じファイルを編集、同じリソースを使用）

## セッションからの実例

**シナリオ:** 大規模リファクタリング後、3ファイルで6つのテスト失敗

**失敗:**

- agent-tool-abort.test.ts: 3つの失敗（タイミングの問題）
- batch-completion-behavior.test.ts: 2つの失敗（ツールが実行されない）
- tool-approval-race-conditions.test.ts: 1つの失敗（実行回数 = 0）

**判断:** 独立したドメイン - 中止ロジック、バッチ完了、レースコンディションはそれぞれ別

**ディスパッチ:**

```
エージェント1 → agent-tool-abort.test.tsを修正
エージェント2 → batch-completion-behavior.test.tsを修正
エージェント3 → tool-approval-race-conditions.test.tsを修正
```

**結果:**

- エージェント1: タイムアウトをイベントベースの待機に置き換え
- エージェント2: イベント構造のバグを修正（threadIdが間違った場所に）
- エージェント3: 非同期ツール実行完了の待機を追加

**統合:** すべての修正が独立、競合なし、フルスイートがグリーン

**節約した時間:** 逐次ではなく並列で3つの問題を解決

## 検証

エージェントが戻った後:

1. **各サマリーをレビュー** - 何が変わったか理解
2. **競合を確認** - エージェントが同じコードを編集したか？
3. **フルスイートを実行** - すべての修正が一緒に動作することを検証
4. **スポットチェック** - エージェントは体系的なエラーを起こす可能性がある
