---
name: pre-pr-interrogation
description: PR作成前の厳格な自己レビュー。実装完了後・PR作成前に使用。Claudeがレビュー担当者として質問攻めを行い、すべての質問に合格するまでPRを作らない。
model: opus
context: fork
---

# Pre-PR Interrogation（PR前質問攻め）

## 概要

実装完了後、PR作成前にClaudeがレビュー担当者役として厳格な質問攻めを行う。
すべての質問に合格するまでPRは作成しない。

## 既存設定との関係

- **Phase 4（@context/workflow-rules.md）**: 品質確認フェーズを強化・代替
- **pr-review（@skills/pr-review/SKILL.md）**: PR作成後のレビュー→本スキルはPR作成前
- **claude cli別セッションレビュー**: 従来の「指摘→修正」を「質問攻め→合格」に昇格

## トリガー条件

- 「質問攻めにして」「テストに合格するまでPRは作らないで」と言われた場合
- 「厳格にレビューして」「PRを出す前にチェックして」と言われた場合
- `/pre-pr-interrogation` で明示的に呼び出された場合

## ワークフロー

### Phase 1: 変更の把握

```bash
# 変更内容を取得
git diff $BASE_BRANCH --stat
git diff $BASE_BRANCH
```

変更されたファイル、追加行数、削除行数を把握。

### Phase 2: 質問攻め（Interrogation Loop）

**レビュー担当者モードに切り替え:**

以下の観点から質問を投げかける。各質問に対してユーザー（または自分の実装）が回答し、合格するまで繰り返す。

#### 2.1 質問カテゴリ

| カテゴリ | 質問例 |
|---------|--------|
| **意図** | この変更で何を達成しようとしている？なぜこのアプローチを選んだ？ |
| **エッジケース** | nullの場合は？空配列の場合は？並行実行された場合は？ |
| **エラーハンドリング** | この処理が失敗したらどうなる？リトライは必要？ |
| **パフォーマンス** | N+1クエリは発生しない？大量データでも動作する？ |
| **セキュリティ** | ユーザー入力は適切にバリデーションされている？権限チェックは？ |
| **テスト** | この変更をカバーするテストは？境界値テストは？ |
| **既存コードとの整合性** | 既存パターンに従っている？命名規則は統一されている？ |
| **影響範囲** | この変更で壊れる可能性のある機能は？後方互換性は？ |

#### 2.2 質問プロセス

1. **3〜5個の質問を AskUserQuestion ツールで提示**
   - 各質問に選択肢（「問題なし」「要確認」「修正必要」等）を用意
   - multiSelect: false で1つずつ回答を得る
   - 1回のAskUserQuestionで最大4問まで（5問以上は複数回に分割）
2. **各回答を評価**: 合格 / 不合格（追加質問 or 修正実行）
3. **全質問に合格するまでループ**

**AskUserQuestion使用例:**
```json
{
  "questions": [
    {
      "question": "リトライ中に別のリクエストが来た場合の処理は実装されていますか？",
      "header": "並行処理",
      "options": [
        { "label": "対応済み", "description": "排他制御やキューイングで対応している" },
        { "label": "不要", "description": "この処理では並行実行は発生しない" },
        { "label": "要修正", "description": "考慮漏れがあるので修正が必要" }
      ],
      "multiSelect": false
    }
  ]
}
```

#### 2.3 不合格時のアクション

質問に対して実装が不十分な場合:

```
「今の知識を踏まえた上で、これは捨てて、もっとエレガントな解決策を実装して」
```

のスタンスで、より良い実装を提案・実行する。

### Phase 3: 合格判定

すべての質問に合格したら:

```markdown
## Pre-PR Interrogation 結果

### 合格した質問
- [x] 意図の明確性
- [x] エッジケースの考慮
- [x] エラーハンドリング
- [x] パフォーマンス
- [x] セキュリティ
- [x] テストカバレッジ
- [x] 既存コードとの整合性

### 改善された点
- <質問によって改善された内容>

### PR作成準備完了
すべての質問に合格しました。PRを作成できます。
```

### Phase 4: PR作成へ

合格後、ユーザーの指示に従い:
- `/pr` でPR作成
- または手動でPR作成

## 質問の厳格さレベル

| レベル | 説明 | 用途 |
|--------|------|------|
| **Standard** | 基本的な質問（意図、エッジケース、テスト） | 通常の変更 |
| **Strict** | 全カテゴリの質問 + 詳細な実装確認 | 重要な変更、セキュリティ関連 |
| **Critical** | 全カテゴリ + 設計判断の妥当性 + 代替案の検討 | 本番影響大、アーキテクチャ変更 |

デフォルトは **Standard**。ユーザーが「厳格に」と言った場合は **Strict**。

## 使用例

```
ユーザー: 実装完了した。この変更について質問攻めにして。テストに合格するまでPRは作らないで。

Claude: レビュー担当者として質問攻めを開始します。

## 変更内容の確認
- 変更ファイル: 5件
- 追加: +120行 / 削除: -30行

## 質問 Round 1

1. **意図**: ユーザー認証のリトライ処理を追加していますが、なぜ3回のリトライ回数を選びましたか？
2. **エッジケース**: リトライ中に別のリクエストが来た場合、どうなりますか？
3. **エラーハンドリング**: 3回リトライしても失敗した場合、ユーザーにはどのようなエラーが表示されますか？

これらの質問に回答してください。
```

## 禁止事項

- 質問に合格していないのにPR作成を許可すること
- 形式的な質問だけで終わらせること（実装の本質を突く質問をする）
- 改善点があるのに「問題ない」と判定すること
