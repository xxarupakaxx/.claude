# コア技術 詳細リファレンス

## 1. Few-Shot Learning（少数例学習）

ルールを説明する代わりに、例を見せてモデルに教える。望ましい動作を示す2-5個の入出力ペアを含める。一貫したフォーマット、特定の推論パターン、エッジケースの処理が必要な場合に使用。例が多いほど精度は向上するがトークンを消費する—タスクの複雑さに応じてバランスを取る。

**例:**

```markdown
サポートチケットから重要な情報を抽出:

入力: "ログインできず、エラー403が出続ける"
出力: {"issue": "authentication", "error_code": "403", "priority": "high"}

入力: "機能リクエスト: 設定にダークモードを追加してほしい"
出力: {"issue": "feature_request", "error_code": null, "priority": "low"}

次を処理: "10MB以上のファイルをアップロードできず、タイムアウトする"
```

## 2. Chain-of-Thought（思考の連鎖）プロンプティング

最終回答の前にステップバイステップの推論を要求する。「ステップバイステップで考えてみましょう」（ゼロショット）を追加するか、推論の例（Few-shot）を含める。複数ステップのロジック、数学的推論が必要な複雑な問題、またはモデルの思考プロセスを検証する必要がある場合に使用。分析タスクの精度を30-50%向上させる。

**例:**

```markdown
このバグレポートを分析し、根本原因を特定。

ステップバイステップで考える:
1. 期待される動作は何か？
2. 実際の動作は何か？
3. これを引き起こす可能性のある最近の変更は何か？
4. 関係するコンポーネントは何か？
5. 最も可能性の高い根本原因は何か？

バグ: "昨日キャッシュ更新がデプロイされた後、ユーザーが下書きを保存できない"
```

## 3. プロンプト最適化

テストと改良を通じてプロンプトを体系的に改善する。シンプルに始め、パフォーマンス（精度、一貫性、トークン使用量）を測定し、反復する。エッジケースを含む多様な入力でテスト。バリエーションを比較するためにA/Bテストを使用。一貫性とコストが重要な本番プロンプトに不可欠。

**例:**

```markdown
バージョン1（シンプル）: "この記事を要約して"
→ 結果: 長さが不安定、重要なポイントを見落とす

バージョン2（制約を追加）: "3つの箇条書きで要約して"
→ 結果: 構造は改善、しかしまだニュアンスを見落とす

バージョン3（推論を追加）: "3つの主要な発見を特定し、それぞれを要約して"
→ 結果: 一貫性があり、正確で、重要な情報を捉える
```

## 4. テンプレートシステム

変数、条件付きセクション、モジュール式コンポーネントを持つ再利用可能なプロンプト構造を構築する。マルチターン会話、ロールベースのインタラクション、または同じパターンが異なる入力に適用される場合に使用。重複を減らし、類似タスク間の一貫性を確保する。

**例:**

```python
# 再利用可能なコードレビューテンプレート
template = """
この{language}コードを{focus_area}の観点でレビュー。

コード:
{code_block}

以下についてフィードバック:
{checklist}
"""

# 使用方法
prompt = template.format(
    language="Python",
    focus_area="セキュリティ脆弱性",
    code_block=user_code,
    checklist="1. SQLインジェクション\n2. XSSリスク\n3. 認証"
)
```

## 5. システムプロンプト設計

会話全体で持続するグローバルな動作と制約を設定する。モデルの役割、専門レベル、出力フォーマット、安全ガイドラインを定義する。ターンごとに変更すべきでない安定した指示にシステムプロンプトを使用し、ユーザーメッセージのトークンを可変コンテンツのために解放する。

**例:**

```markdown
System: あなたはAPI設計を専門とするシニアバックエンドエンジニアです。

ルール:
- 常にスケーラビリティとパフォーマンスを考慮
- デフォルトでRESTfulパターンを提案
- セキュリティの懸念は即座にフラグを立てる
- Pythonでコード例を提供
- 早期リターンパターンを使用

レスポンスフォーマット:
1. 分析
2. 推奨
3. コード例
4. トレードオフ
```

---

## 統合パターン

### RAGシステムとの統合

```python
# 取得したコンテキストとプロンプトエンジニアリングを組み合わせる
prompt = f"""以下のコンテキストに基づいて:
{retrieved_context}

{few_shot_examples}

質問: {user_question}

上記のコンテキストのみに基づいて詳細な回答を提供してください。コンテキストに十分な情報がない場合は、何が不足しているか明示的に述べてください。"""
```

### バリデーションとの統合

```python
# 自己検証ステップを追加
prompt = f"""{main_task_prompt}

レスポンスを生成した後、以下の基準を満たしているか検証:
1. 質問に直接回答している
2. 提供されたコンテキストからの情報のみを使用している
3. 特定のソースを引用している
4. 不確実性を認めている

検証に失敗した場合は、レスポンスを修正してください。"""
```

## パフォーマンス最適化

### トークン効率

- 冗長な言葉やフレーズを削除
- 最初の定義後は一貫して略語を使用
- 類似の指示を統合
- 安定したコンテンツをシステムプロンプトに移動

### レイテンシ削減

- 品質を損なわずにプロンプト長を最小化
- 長文出力にはストリーミングを使用
- 一般的なプロンプトプレフィックスをキャッシュ
- 可能な場合は類似リクエストをバッチ処理
