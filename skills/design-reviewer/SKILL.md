---
name: design-reviewer
description: 設計ドキュメント（.kiro/specs/の design.md）のレビュー。設計レビュー依頼時、またはSDDのタスク間レビューで設計ドキュメントが出力された場合に使用。要件との整合性・既存アーキテクチャとの整合・インタフェース整合・考慮漏れを検証し、人間向けサマリーを生成。
context: fork
---

# Design Reviewer

設計ドキュメント（`.kiro/specs/<feature>/design.md`）をレビューし、問題を Critical/High/Medium で分類して報告する。人間が全文を読まなくても判断できるサマリーを生成する。

## 既存設定との関係

- **brainstorming**: brainstormingで設計を作成 → design-reviewerでレビュー
- **pr-review**: コードレビューのドキュメント版。分類体系（Critical/High/Medium）を共有

## トリガー条件

- 設計ドキュメントのレビューを依頼された場合
- `.kiro/specs/<feature>/design.md` のパスが指定された場合
- SDDがドキュメント出力タスクのレビューをディスパッチした場合

## レビュープロセス

### Step 1: 入力の特定と精読

レビュー対象のspecディレクトリを特定する:

```
.kiro/specs/<feature>/
├── requirements.md    # 要件定義（レビューの基準）
├── design.md          # レビュー対象
└── tasks.md           # タスク分解（あれば参照）
```

**IMPORTANT: requirements.md の精読**

requirements.md が存在する場合、**全文を省略せずに精読**すること。サマリーや要約では不十分。以下を把握する:

- すべての要件（ユーザーストーリー）
- すべての受入基準（WHEN-THEN 形式）
- 用語集の定義
- 非機能要件（あれば）

**この段階で requirements.md の各受入基準を一覧化し、後続の検証で使用する。**

requirements.md が存在しない場合: design.md 単体でレビュー可能だが、要件カバレッジの検証はスキップし、その旨を報告する。

### Step 1.5: 外部仕様の取得（Confluence）

外部仕様の Confluence URL を特定する。design.md や AGENTS.md 等から自動検出してはならない。

#### 1.5.1 外部仕様URLの特定

**呼び出し元に応じて取得方法が異なる:**

- **直接呼び出し（ユーザーがレビューを依頼）**: AskUserQuestion でユーザーに外部仕様の Confluence URL を確認する。ユーザーが「なし」と回答した場合は外部仕様なしで続行する。
- **SDD経由（サブエージェントとしてディスパッチ）**: プロンプトに `CONFLUENCE_URL` が含まれていればそれを使用する。含まれていなければ外部仕様なしで続行する。AskUserQuestion は使用できないため、プロンプトから情報を取得すること。

#### 1.5.2 mcp-atlassian でページ取得

**必ず `mcp-atlassian` の MCP ツールを使用すること**。接続状態はツール呼び出し時のエラー有無で判断する。

```
# ページIDからコンテンツを取得
mcp__mcp-atlassian__confluence_get_page(page_id: "<ページID>")

# キーワードで関連ページを検索
mcp__mcp-atlassian__confluence_search(query: "<CQL>")
```

**URL からページ ID を特定する方法**:

- URL パスの `/pages/<数字>/` 部分がページ ID
- 例: `https://dena0.atlassian.net/wiki/spaces/YDBSOL/pages/1012400821/-` → ページ ID: `1012400821`

#### 1.5.3 mcp-atlassian が利用できない場合

MCP サーバーが未設定・未接続の場合はスキップし、レビューサマリーに以下を記載する:

> Confluence 外部仕様の検証をスキップしました（mcp-atlassian が未接続）。
> 対象 URL: [検出された URL リスト]

### Step 2: レビュー観点（サブエージェント並列レビュー）

**IMPORTANT: 観点が多いため、Taskツールの専門サブエージェントを並列起動して効率化する。**

以下のサブエージェントを並列起動し、観点を分担:

| subagent_type | 担当観点 |
|---------------|---------|
| `arch-reviewer` | 2.2 アーキテクチャ整合, 2.3 インタフェース整合, 2.7 技術的実現可能性 |
| `security-reviewer` | 2.4 スコープ・非機能（セキュリティ面）, 2.8 エラーハンドリング |
| `perf-reviewer` | 2.10 パフォーマンス・スケーラビリティ |

**自身が担当する観点:**
- 2.1 要件カバレッジ（requirements.md との照合が必要）
- 2.5 未決定事項・考慮漏れ
- 2.6 前提の正しさ（Step 3 で実行）
- 2.9 テスト戦略
- 2.11 外部仕様整合

**各サブエージェントに渡す情報:**
- design.md のフルパス
- requirements.md のフルパス（あれば）
- PJ の CLAUDE.md のパス
- 出力形式: Critical/High/Medium 分類

以下の11観点で検証する。優先度グループ順に実施し、上位グループの問題を優先的に報告する:

| 優先度     | 観点                                                                                 | Critical直結度 |
| ---------- | ------------------------------------------------------------------------------------ | -------------- |
| P1（必須） | 2.1 要件カバレッジ, 2.2 アーキテクチャ整合, 2.3 インタフェース整合, 2.6 前提の正しさ | 高             |
| P2（重要） | 2.4 スコープ・非機能, 2.5 未決定事項, 2.7 技術的実現可能性, 2.8 エラーハンドリング   | 中             |
| P3（推奨） | 2.9 テスト戦略, 2.10 パフォーマンス, 2.11 外部仕様整合                               | 低             |

**各観点の詳細は `Read references/review-perspectives.md` を参照。**

### Step 3: 設計の前提検証（Step 2.6の実行手順）

**`Read references/verification-steps.md` の手順に従って検証を実行する。**

### Step 4: 問題の分類

| 分類     | 説明                                     | 例                                                                 |
| -------- | ---------------------------------------- | ------------------------------------------------------------------ |
| Critical | 要件未達・設計上の重大な矛盾・前提の誤り | 要件の欠落、存在しないコンポーネントを前提とした設計、依存境界違反 |
| High     | 設計の不備・考慮漏れ・リスクの高い判断   | エラー戦略の欠如、状態遷移の欠落、インタフェース不整合             |
| Medium   | 改善推奨・曖昧な記述・明文化の不足       | スコープ境界の曖昧さ、テスト戦略の不足、未決定事項の明文化         |

### Step 5: 人間向けサマリー生成

**`Read templates/review-summary.md` のテンプレートを使用してサマリーを生成する。**

### Step 5.5: Round形式の対話的確認（IMPORTANT）

**レビュー結果を一括レポートとして投げるのではなく、重要度別Roundでユーザーと対話的に確認する。**

**SDD経由時（サブエージェントとしてディスパッチされた場合）はこのステップをスキップし、Step 6 へ進む。**

各RoundでAskUserQuestionを使い、**1回最大4問まで**（5問以上は複数回に分割）:

| Round | 対象 | options |
|-------|------|---------|
| 1 | Critical | "修正する" / "対応不要" / "要議論" |
| 2 | High | "修正する" / "対応不要" / "後で対応" |
| 3 | Medium | "修正する" / "対応不要" / "後で対応" |

- 各指摘の question: `"[観点] 指摘内容の要約。詳細: ..."`、header: 分類名
- 該当0件のRoundはスキップ
- 全Round完了後、ユーザー回答を反映した最終サマリーを生成し、Step 6 へ

### Step 6: 修正方針の提示と再生成→再レビューの案内

レビュー完了後、指摘事項に基づく修正方針を列挙し、`spec-design` での設計再生成と `design-reviewer` での再レビューを案内する。

#### 6.1 修正方針の列挙

Step 4 で分類した各指摘について、具体的な修正方針を箇条書きで整理する:

```markdown
## 修正方針

1. [指摘の要約]: [具体的にどう修正すべきか]
2. [指摘の要約]: [具体的にどう修正すべきか]
3. ...
```

**修正方針の記述ルール:**
- 各方針は design.md のどの箇所をどう変更すべきか具体的に記述する
- Critical/High の指摘を優先的に列挙する
- 設計判断が必要な項目（human-required）は選択肢を併記する

#### 6.2 再生成→再レビューサイクルの案内

修正方針の列挙後、以下のサイクルを案内する:

1. `/kiro:spec-design <feature名>` → 修正方針を反映して design.md を再生成
2. `/design-reviewer` → 再生成された design.md を同じ11観点でフルレビュー
3. Critical/High がなくなるまで 1→2 を繰り返す
4. 指摘なしの場合 → `/kiro:spec-tasks <feature名>` でタスク分解に進む

**SDD経由時:** レビュー結果に修正方針リストを含めて返却する。再生成→再レビューの実行判断は呼び出し元に委ねる。

## 禁止事項

- design.md を読まずにレビュー結果を返すこと
- requirements.md が存在するのに読まないこと
- requirements.md をサマリー・要約で済ませること（全文精読が必須）
- 設計の前提（参照する既存コンポーネント等）の実在性を確認せず「問題なし」と判断すること
- Critical問題があるのに「承認」を推奨すること
- 未決定事項の抽出をスキップすること
- サマリーテンプレートの必須セクションを省略すること（条件付きセクション「外部仕様カバレッジ」はConfluence未参照時のみ省略可。それ以外のセクションは該当なしでも「なし」と明記すること）
