---
name: design-reviewer
description: 設計ドキュメント（.kiro/specs/の design.md）のレビュー。設計レビュー依頼時、またはSDDのタスク間レビューで設計ドキュメントが出力された場合に使用。要件との整合性・既存アーキテクチャとの整合・インタフェース整合・考慮漏れを検証し、人間向けサマリーを生成。
---

# Design Reviewer

設計ドキュメント（`.kiro/specs/<feature>/design.md`）をレビューし、問題を Critical/High/Medium で分類して報告する。人間が全文を読まなくても判断できるサマリーを生成する。

## 既存設定との関係

- **SDD（subagent-driven-development）**: タスク間レビューでcode-reviewerの代わりにディスパッチされる（出力がdesign.mdの場合）
- **brainstorming**: brainstormingで設計を作成 → design-reviewerでレビュー
- **pr-review**: コードレビューのドキュメント版。分類体系（Critical/High/Medium）を共有

## トリガー条件

- 設計ドキュメントのレビューを依頼された場合
- `.kiro/specs/<feature>/design.md` のパスが指定された場合
- SDDがドキュメント出力タスクのレビューをディスパッチした場合

## レビュープロセス

### Step 1: 入力の特定と精読

レビュー対象のspecディレクトリを特定する:

```
.kiro/specs/<feature>/
├── requirements.md    # 要件定義（レビューの基準）
├── design.md          # レビュー対象
└── tasks.md           # タスク分解（あれば参照）
```

**IMPORTANT: requirements.md の精読**

requirements.md が存在する場合、**全文を省略せずに精読**すること。サマリーや要約では不十分。以下を把握する:

- すべての要件（ユーザーストーリー）
- すべての受入基準（WHEN-THEN 形式）
- 用語集の定義
- 非機能要件（あれば）

**この段階で requirements.md の各受入基準を一覧化し、後続の検証で使用する。**

requirements.md が存在しない場合: design.md 単体でレビュー可能だが、要件カバレッジの検証はスキップし、その旨を報告する。

### Step 1.5: 外部仕様の取得（Confluence）

外部仕様の Confluence URL を特定する。design.md や AGENTS.md 等から自動検出してはならない。

#### 1.5.1 外部仕様URLの特定

**呼び出し元に応じて取得方法が異なる:**

- **直接呼び出し（ユーザーがレビューを依頼）**: AskUserQuestion でユーザーに外部仕様の Confluence URL を確認する。ユーザーが「なし」と回答した場合は外部仕様なしで続行する。
- **SDD経由（サブエージェントとしてディスパッチ）**: プロンプトに `CONFLUENCE_URL` が含まれていればそれを使用する。含まれていなければ外部仕様なしで続行する。AskUserQuestion は使用できないため、プロンプトから情報を取得すること。

#### 1.5.2 mcp-atlassian でページ取得

**必ず `mcp-atlassian` の MCP ツールを使用すること**。接続状態はツール呼び出し時のエラー有無で判断する。

```
# ページIDからコンテンツを取得
mcp__mcp-atlassian__confluence_get_page(page_id: "<ページID>")

# キーワードで関連ページを検索
mcp__mcp-atlassian__confluence_search(query: "<CQL>")
```

**URL からページ ID を特定する方法**:

- URL パスの `/pages/<数字>/` 部分がページ ID
- 例: `https://dena0.atlassian.net/wiki/spaces/YDBSOL/pages/1012400821/-` → ページ ID: `1012400821`

#### 1.5.3 mcp-atlassian が利用できない場合

MCP サーバーが未設定・未接続の場合はスキップし、レビューサマリーに以下を記載する:

> Confluence 外部仕様の検証をスキップしました（mcp-atlassian が未接続）。
> 対象 URL: [検出された URL リスト]

### Step 2: レビュー観点

以下の11観点で検証する。優先度グループ順に実施し、上位グループの問題を優先的に報告する:

| 優先度     | 観点                                                                                 | Critical直結度 |
| ---------- | ------------------------------------------------------------------------------------ | -------------- |
| P1（必須） | 2.1 要件カバレッジ, 2.2 アーキテクチャ整合, 2.3 インタフェース整合, 2.6 前提の正しさ | 高             |
| P2（重要） | 2.4 スコープ・非機能, 2.5 未決定事項, 2.7 技術的実現可能性, 2.8 エラーハンドリング   | 中             |
| P3（推奨） | 2.9 テスト戦略, 2.10 パフォーマンス, 2.11 外部仕様整合                               | 低             |

#### 2.1 要件カバレッジ（requirements.md が必要）

- requirements.md の**各受入基準**がdesign.mdのどこでカバーされているか（1対1で対応付け）
- カバーされていない要件はないか
- 過剰な設計はないか（判断基準: requirements.md の要件・受入基準のいずれにも対応しない設計要素。ただし、要件を満たすために技術的に必要な基盤設計（エラーハンドリング共通化、DB接続管理等）は過剰設計に該当しない）
- 要件の意図が正しく設計に反映されているか（文言の一致ではなく意味の一致）

#### 2.2 既存アーキテクチャ・制約との整合

- **依存境界**: 設計が既存のモジュール境界・レイヤー構成を守っているか
  - 例: backend → cms の直接参照、gateway を迂回するアクセスなど
- **既存方針**: プロジェクトで採用している設計方針（スキーマファースト、エラーハンドリング方針等）に沿っているか
- **採用技術スタック**: 使用するライブラリ・フレームワークがプロジェクトの技術スタックに含まれるか
  - 新規ライブラリ導入がある場合は明示的に指摘
- **ディレクトリ構成**: 新規ファイル・モジュールの配置が既存構成と整合しているか

#### 2.3 既存システムとのインタフェース整合

- **契約（Contract）**: 設計で定義されたコンポーネント間のインタフェースが、既存システムのインタフェースと整合しているか
- **責務（Responsibility）**: 各コンポーネントに割り当てられた責務が、既存の責務分担パターンと矛盾しないか
- **データ定義**: 設計で想定するデータモデルが既存のデータ構造と整合しているか
  - データモデル変更がある場合、既存データとの互換性・移行方針が設計で考慮されているか
- **外部システム連携**: 外部システムとのインタフェース（入出力の形式、認証方式、呼び出し順序等）が設計上正しく定義されているか

#### 2.4 スコープ境界と非機能要件

- **スコープ境界**: 設計のスコープが明確か。何をやり、何をやらないかが定義されているか
- **非機能要件の網羅性**: パフォーマンス、セキュリティ、可用性、監視等の非機能要件が考慮されているか
  - requirements.md で言及されている非機能要件がすべて設計に反映されているか
- **状態遷移**: ステートフルな処理がある場合、状態遷移が明確に定義されているか
  - 遷移条件、各状態でのガード条件、不正遷移の防止が考慮されているか
- **べき等性**: バッチ処理・イベント処理がある場合、再実行時の安全性が設計されているか

#### 2.5 未決定事項・考慮漏れの抽出

**設計判断（Step 5の「設計判断」セクション）とは異なる観点**。トレードオフの選択ではなく、**そもそも検討されていない事項**を抽出する:

- 設計で言及されていないが、requirements.md に含まれる要件はないか
- 設計で暗黙的に前提としているが、明文化されていない前提条件はないか
- エッジケース・異常系で検討が不足している箇所はないか
- 運用面（デプロイ手順、フィーチャーフラグ、ロールバック方針等）の考慮が必要ないか
- データの初期化・マイグレーション・既存データの扱いが未定義でないか

#### 2.6 設計の前提の正しさ

以下の観点で確認する（具体的な検証手順は Step 3 を参照）:

- design.md が前提としている既存コンポーネント・モジュールが実在するか
- 設計で参照されているインタフェースや振る舞いが、実際の既存システムと一致するか
- 設計で想定したモジュール配置が既存のディレクトリ構成・命名規則に沿っているか

#### 2.7 技術的実現可能性

- 設計で提案されたアプローチが、採用技術スタックの制約内で実現可能か
- 依存する外部ライブラリ・サービスが利用可能か
- 設計上のデータフローに矛盾がないか

#### 2.8 エラーハンドリング・エッジケース

- 設計でエラーパスが網羅されているか
- フェイルオープン/フェイルクローズの戦略が設計レベルで明記されているか
- 境界値・異常系の考慮が設計に含まれているか

#### 2.9 テスト戦略

- テスト戦略が要件をカバーしているか
- 設計がテスト容易性を考慮しているか（コンポーネント間の疎結合等）
- プロパティベーステストが適切に定義されているか（あれば）

#### 2.10 パフォーマンス・スケーラビリティ

- パフォーマンス要件に対する設計が妥当か
- 設計上のデータアクセスパターンにパフォーマンスリスクがないか
- キャッシュ戦略・スケーリング方針が設計で考慮されているか（要件にあれば）

#### 2.11 外部仕様との整合性（Confluence ページ取得時のみ）

- 外部仕様に記載された機能・画面・挙動が設計でカバーされているか
- 外部仕様と設計の間に矛盾がないか
- 外部仕様に記載されているが設計で言及されていない項目はないか

### Step 3: 設計の前提検証（Step 2.6の実行手順）

**design.md が前提としている既存システムの情報を、ツールを使って検証する。** Step 2.6の各観点を以下の手順で確認する:

#### 3.1 既存コンポーネント・モジュールの実在確認

design.md が参照するコンポーネント名・関数名・モジュール名をリストアップし、それぞれ存在を確認する:

```
# コンポーネント・関数の実在確認
Glob: パターンでファイルを探す（例: "**/processAdmissions*"）
Grep: 関数名・クラス名で検索（例: pattern="function processAdmissions"）
Read: 該当ファイルを読み、インタフェース（引数・戻り値・型）を確認
```

#### 3.2 既存インタフェースとの整合確認

設計で前提としているインタフェースの振る舞いが、実際のコードと一致するか確認する:

```
# インタフェースの確認
Read: 該当ファイルを読み、関数シグネチャ・型定義を確認
Grep: 型定義や export を検索（例: pattern="export.*ComponentName"）
```

#### 3.3 影響範囲の漏れ確認

設計で言及されていない呼び出し元・依存先がないか確認する:

```
# 呼び出し元・依存先の確認
Grep: 変更対象の関数名・モジュール名で全体検索（例: pattern="import.*from.*moduleName"）
→ 設計で言及されていない呼び出し元があれば指摘する
```

#### 例

```
design.md が「既存の processAdmissions 関数を変更する」と記載
→ Grep で "processAdmissions" を検索し、関数が実在するか確認
→ Read で関数の現在のインタフェースが設計の前提と一致するか確認
→ Grep で "processAdmissions" の呼び出し元を全件検索し、設計で言及されていない呼び出し元がないか確認
```

### Step 4: 問題の分類

| 分類     | 説明                                     | 例                                                                 |
| -------- | ---------------------------------------- | ------------------------------------------------------------------ |
| Critical | 要件未達・設計上の重大な矛盾・前提の誤り | 要件の欠落、存在しないコンポーネントを前提とした設計、依存境界違反 |
| High     | 設計の不備・考慮漏れ・リスクの高い判断   | エラー戦略の欠如、状態遷移の欠落、インタフェース不整合             |
| Medium   | 改善推奨・曖昧な記述・明文化の不足       | スコープ境界の曖昧さ、テスト戦略の不足、未決定事項の明文化         |

### Step 5: 人間向けサマリー生成

**design.md全文を読まなくても判断できるサマリー**を生成する:

```markdown
# 設計レビュー: <feature名>

## 概要

- 設計: .kiro/specs/<feature>/design.md
- 要件: .kiro/specs/<feature>/requirements.md
- 外部仕様: [Confluence URL（あれば）/ なし]

## サマリー（3行以内）

[この設計が何をするか、1-3文で]

## 影響範囲

- 変更ファイル: [リスト]
- 新規ファイル: [リスト]
- DB変更: [あれば]
- 新規API: [あれば]

## 要件カバレッジ

| 要件    | カバー状況 | 設計箇所        |
| ------- | ---------- | --------------- |
| 要件1.1 | OK         | コンポーネント1 |
| 要件1.2 | 不足       | -               |

## 外部仕様カバレッジ（Confluence 参照時のみ）

| 外部仕様の項目 | カバー状況 | 設計箇所 | 備考 |
| -------------- | ---------- | -------- | ---- |
| 項目1          | OK         | ...      |      |
| 項目2          | 不足       | -        | ...  |

## アーキテクチャ整合性

- 依存境界: [OK / 違反あり（詳細）]
- 技術スタック: [OK / 新規ライブラリあり（詳細）]
- インタフェース整合: [OK / 不整合あり（詳細）]

## 指摘事項

### Critical

- [指摘内容と理由]

### High

- [指摘内容と理由]

### Medium

- [指摘内容と理由]

## 未決定事項・考慮漏れ

[設計で検討されていない事項をリストアップ]

1. [未決定事項1]: [詳細と影響]
2. [未決定事項2]: [詳細と影響]

## 設計判断（人間確認推奨）

[AIでは判断が難しい、ビジネス判断やトレードオフを要約]

1. [判断1]: [選択肢A] vs [選択肢B] → 設計では[A]を採用。理由: ...
2. [判断2]: ...

## 自動修正可能な指摘

| #   | 指摘       | 分類           | 修正内容           |
| --- | ---------- | -------------- | ------------------ |
| 1   | [指摘内容] | auto-fixable   | [具体的な修正内容] |
| 2   | [指摘内容] | human-required | [判断が必要な理由] |

## 総合評価

- 実装可能性: [High/Medium/Low]
- 要件充足度: [XX%]（算出基準: requirements.md の受入基準の総数を分母、design.md でカバーされている受入基準の数を分子とする。requirements.md がない場合は「N/A」）
- アーキテクチャ整合性: [High/Medium/Low]
- 推奨アクション: [承認/修正後承認/再設計]
```

### Step 6: 自動修正の提案と実行

レビュー完了後、指摘事項の中に自動修正可能なものがあれば、ユーザーに修正を提案する。

#### 6.1 指摘の修正可能性分類

Step 4 で分類した各指摘を、さらに以下の2種類に分類する:

| 分類               | 定義                                                               | 例                                                                                                                           |
| ------------------ | ------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| **auto-fixable**   | コードベースの情報から正しい内容を特定でき、設計判断なしに修正可能 | 関数名・型名の誤り修正、既存インタフェース記述の訂正、セクション（スコープ境界・テスト戦略等）の雛形追加、暗黙の前提の明文化 |
| **human-required** | 設計判断・ビジネス判断・トレードオフ選択が必要                     | 要件欠落への対応方針、アーキテクチャ選択、非機能要件の水準決定、スコープの拡大/縮小判断                                      |

**分類のルール:**

- Critical 指摘は原則 **human-required**（設計の根本に関わるため）。ただし、前提の事実誤認（存在しない関数名等）の修正のみ auto-fixable
- High/Medium 指摘は内容に応じて分類

#### 6.2 修正の提案

**直接呼び出し時:**

auto-fixable な指摘が1件以上ある場合、AskUserQuestion でユーザーに提案する:

- 「以下の指摘は自動修正可能です。サブエージェントで design.md を修正しますか？」
- auto-fixable 指摘の一覧と、各指摘の修正内容を提示
- ユーザーが承認した場合のみ Step 6.3 に進む

**SDD経由時:**

AskUserQuestion は使用不可のため、レビュー結果の「自動修正可能な指摘」セクションにリストを含めて返却する。修正実行の判断は呼び出し元に委ねる。

#### 6.3 サブエージェントによる修正実行

ユーザーが承認した場合、Task ツールでサブエージェントを起動して design.md を修正する:

```
Task tool:
  subagent_type: general-purpose
  description: "設計ドキュメントの自動修正"
  prompt: |
    以下の指摘に基づいて design.md を修正してください。

    対象ファイル: .kiro/specs/<feature>/design.md

    修正する指摘:
    [auto-fixable 指摘リスト（各指摘の修正内容を含む）]

    修正ルール:
    - 指定された修正内容のみを適用すること
    - 設計の意図や構造を変えないこと
    - 修正箇所以外を変更しないこと
    - 修正後、変更した箇所の一覧を返却すること
```

#### 6.4 修正結果の確認

サブエージェントの修正結果を確認し、意図通りの修正が行われたかを検証する。問題があれば修正差分を報告し、ユーザーに手動修正を依頼する。

## SDDとの統合

SDDのタスク間レビューでdesign.mdが出力された場合、code-reviewerの代わりにこのスキルを使用する:

```
Task tool:
  description: "設計ドキュメントをレビュー"
  prompt: |
    design-reviewerスキルに従って、以下の設計ドキュメントをレビューしてください。

    対象: .kiro/specs/<feature>/design.md
    要件: .kiro/specs/<feature>/requirements.md
    CONFLUENCE_URL: [外部仕様のURL（あれば）/ なし]

    WHAT_WAS_DESIGNED: [サブエージェントの報告から]
    DESCRIPTION: [タスクのサマリー]

    ※ サブエージェントとして実行されるため、AskUserQuestion は使用不可。
    CONFLUENCE_URL が「なし」の場合は外部仕様の検証をスキップすること。
    auto-fixable な指摘がある場合は「自動修正可能な指摘」セクションにリストを含めること。
    修正実行の判断は呼び出し元に委ねる。

    レビュー結果を構造化された形式で返してください。
```

## 禁止事項

- design.md を読まずにレビュー結果を返すこと
- requirements.md が存在するのに読まないこと
- requirements.md をサマリー・要約で済ませること（全文精読が必須）
- 設計の前提（参照する既存コンポーネント等）の実在性を確認せず「問題なし」と判断すること
- Critical問題があるのに「承認」を推奨すること
- 未決定事項の抽出をスキップすること
- サマリーテンプレートの必須セクションを省略すること（条件付きセクション「外部仕様カバレッジ」はConfluence未参照時のみ省略可。それ以外のセクションは該当なしでも「なし」と明記すること）
