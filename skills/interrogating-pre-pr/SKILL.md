---
name: interrogating-pre-pr
description: Conducts strict human-in-the-loop interrogation before PR creation. Asks probing questions across 8 categories (intent, edge cases, error handling, performance, security, testing, consistency, impact) with scale-based rounds (small 2, medium 3, large 5). Use when user says "質問攻めにして", "厳格にレビュー", "PRの前にチェック", "テストに合格するまでPRは作らないで", or when design intent confirmation is important for smaller changes.
context: current
---

# Pre-PR Interrogation（PR前質問攻め）

## 概要

実装完了後、PR作成前にClaudeがレビュー担当者役として厳格な質問攻めを行う。
**規模別ラウンド**（小: 2、中: 3、大: 5）のレビュー修正サイクルを実施し、すべての質問に合格するまでPRは作成しない。

## 研究的根拠（IMPORTANT）

反復レビューの有効性は研究で裏付けられている:

- **[Security Degradation in Iterative AI Code Generation (IEEE-ISTAS 2025)](https://arxiv.org/abs/2506.11022)**: LLMのみの自己反復は5回で重大な脆弱性が37.6%増加。**LLMのみの連続反復は最大3回まで**、以降は必ず外部フィードバック（静的解析/人間レビュー）を挟むこと。
- **[FDSP: Feedback-Driven Security Patching (Alrashedy et al.)](https://arxiv.org/abs/2312.00024)**: 静的解析フィードバック付き反復でGPT-4の脆弱性率が40.2%→7.4%に低減（82%改善）。

**核心**: 回数を増やすだけでは逆効果。各ラウンドに構造化された外部フィードバック（静的解析ツール + サブエージェントレビュー + 人間確認）を含むことが必須。

## 既存設定との関係

- **Phase 4（@context/workflow-rules.md）**: 品質確認フェーズを強化・代替
- **pr-review（@skills/pr-review/SKILL.md）**: PR作成後のレビュー→本スキルはPR作成前
- **claude cli別セッションレビュー**: 従来の「指摘→修正」を「質問攻め→合格」に昇格

## トリガー条件

- 「質問攻めにして」「テストに合格するまでPRは作らないで」と言われた場合
- 「厳格にレビューして」「PRを出す前にチェックして」と言われた場合
- `/interrogating-pre-pr` で明示的に呼び出された場合

## ワークフロー

### Phase 1: 変更の把握

```bash
# 変更内容を取得
git diff $BASE_BRANCH --stat
git diff $BASE_BRANCH
```

変更されたファイル、追加行数、削除行数を把握。

### Phase 2: 質問攻め（Interrogation Loop — 規模別ラウンド制）

**規模別ラウンド数**（変更ファイル数で判定）:

| 規模 | ファイル数 | 最低ラウンド |
|------|-----------|------------|
| 小 | 1-3 | 2 |
| 中 | 4-9 | 3 |
| 大 | 10+ | 5 |

**レビュー担当者モードに切り替え:**

以下の観点から質問を投げかける。各質問に対してユーザー（または自分の実装）が回答し、合格するまで繰り返す。

#### 2.1 質問カテゴリ

| カテゴリ | 質問例 |
|---------|--------|
| **意図** | この変更で何を達成しようとしている？なぜこのアプローチを選んだ？ |
| **エッジケース** | nullの場合は？空配列の場合は？並行実行された場合は？ |
| **エラーハンドリング** | この処理が失敗したらどうなる？リトライは必要？ |
| **パフォーマンス** | N+1クエリは発生しない？大量データでも動作する？ |
| **セキュリティ** | ユーザー入力は適切にバリデーションされている？権限チェックは？ |
| **テスト** | この変更をカバーするテストは？境界値テストは？ |
| **既存コードとの整合性** | 既存パターンに従っている？命名規則は統一されている？ |
| **影響範囲** | この変更で壊れる可能性のある機能は？後方互換性は？ |

#### 2.2 質問プロセス（規模別ラウンド制）

各ラウンドの構造:

| ステップ | 内容 | 必須 |
|----------|------|------|
| 1. 質問提示 | 3〜5個の質問をAskUserQuestionで提示 | 毎ラウンド |
| 2. 回答評価 | 合格/不合格を判定 | 毎ラウンド |
| 3. 修正実行 | 不合格項目を修正 | 不合格時 |
| 4. 静的解析 | lint/typecheck/test実行で新規問題を検出 | 毎ラウンド |
| 5. サブエージェントレビュー | security-reviewer等で修正箇所を検証 | Round 3, 5 |

**ラウンド進行ルール:**
- **Round 1**: 基本カテゴリ（意図、エッジケース、エラーハンドリング）を中心に質問
- **Round 2**: 全カテゴリから質問 + security-reviewerによる検証
- **Round 3以降**（中・大規模時）: 修正により新たに生じた問題に焦点 + 最終検証
- **最終ラウンドで指摘が残る場合**: 合格するまで追加ラウンドを継続

**LLMのみの連続反復は最大3回まで**（研究知見）。3回連続でLLMのみの修正を行った場合、次は必ず静的解析 + サブエージェントレビュー + 人間確認を挟むこと。

各ラウンドの質問:
- 各質問に選択肢（「問題なし」「要確認」「修正必要」等）を用意
- multiSelect: false で1つずつ回答を得る
- 1回のAskUserQuestionで最大4問まで（5問以上は複数回に分割）

**AskUserQuestion使用例:**
```json
{
  "questions": [
    {
      "question": "リトライ中に別のリクエストが来た場合の処理は実装されていますか？",
      "header": "並行処理",
      "options": [
        { "label": "対応済み", "description": "排他制御やキューイングで対応している" },
        { "label": "不要", "description": "この処理では並行実行は発生しない" },
        { "label": "要修正", "description": "考慮漏れがあるので修正が必要" }
      ],
      "multiSelect": false
    }
  ]
}
```

#### 2.3 不合格時のアクション

質問に対して実装が不十分な場合:

```
「今の知識を踏まえた上で、これは捨てて、もっとエレガントな解決策を実装して」
```

のスタンスで、より良い実装を提案・実行する。

### Phase 3: 合格判定

**規模別最低ラウンド完了後**、すべての質問に合格したら:

```markdown
## Pre-PR Interrogation 結果

### ラウンド実績
- 実施ラウンド数: N（規模別: 小2/中3/大5）
- 検出した問題数: X件
- 修正した問題数: Y件
- サブエージェント検証: Round 3, 5で実施

### 合格した質問
- [x] 意図の明確性
- [x] エッジケースの考慮
- [x] エラーハンドリング
- [x] パフォーマンス
- [x] セキュリティ
- [x] テストカバレッジ
- [x] 既存コードとの整合性
- [x] 影響範囲

### ラウンドごとの改善
- Round 1: <基本レビュー>
- Round 2: <再検証>
- Round N: <最終検証の結果>

### PR作成準備完了
規模別ラウンドのレビュー修正サイクルを完了し、すべての質問に合格しました。PRを作成できます。
```

### Phase 4: PR作成へ

合格後、ユーザーの指示に従い:
- `/pr` でPR作成
- または手動でPR作成

## 質問の厳格さレベル

| レベル | 説明 | 用途 |
|--------|------|------|
| **Standard** | 基本的な質問（意図、エッジケース、テスト） | 通常の変更 |
| **Strict** | 全カテゴリの質問 + 詳細な実装確認 | 重要な変更、セキュリティ関連 |
| **Critical** | 全カテゴリ + 設計判断の妥当性 + 代替案の検討 | 本番影響大、アーキテクチャ変更 |

デフォルトは **Standard**。ユーザーが「厳格に」と言った場合は **Strict**。

## 使用例

```
ユーザー: 実装完了した。この変更について質問攻めにして。テストに合格するまでPRは作らないで。

Claude: レビュー担当者として質問攻めを開始します。

## 変更内容の確認
- 変更ファイル: 5件
- 追加: +120行 / 削除: -30行

## 質問 Round 1

1. **意図**: ユーザー認証のリトライ処理を追加していますが、なぜ3回のリトライ回数を選びましたか？
2. **エッジケース**: リトライ中に別のリクエストが来た場合、どうなりますか？
3. **エラーハンドリング**: 3回リトライしても失敗した場合、ユーザーにはどのようなエラーが表示されますか？

これらの質問に回答してください。
```

## 禁止事項

- 質問に合格していないのにPR作成を許可すること
- **規模別最低ラウンド未満で完了とすること（小: 2、中: 3、大: 5）**
- 形式的な質問だけで終わらせること（実装の本質を突く質問をする）
- 改善点があるのに「問題ない」と判定すること
- LLMのみの修正を4回以上連続で行うこと（必ず外部フィードバックを挟む）
