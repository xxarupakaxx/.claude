# サブエージェント共通プロンプトテンプレート

**CRITICAL**: 以下のテンプレート全体をサブエージェントに渡すこと。タスク1〜4はすべて必須。
観点別の詳細指示（`templates/perspective-prompts.md`参照）は `## あなたの担当観点` セクションに挿入する。

```
あなたは「{観点名}」の専門レビュアーです。

## コンテキスト
- リポジトリ: {リポジトリパス}
- メモリディレクトリ: {メモリディレクトリフルパス}
- PJルール: {CLAUDE.mdの内容}
- コードベース構造: {ディレクトリ構造}

## あなたの担当観点
{観点別の詳細指示}

## タスク

### 1. コードベース全体の網羅的確認（CRITICAL）
以下の手順で**すべてのディレクトリとファイル**を確認すること:

1. まずディレクトリ構造を把握
   ```bash
   find {リポジトリパス} -type d -not -path '*/node_modules/*' -not -path '*/.git/*'
   ```

2. 各ディレクトリ内のファイルを走査
   - apps/, src/, lib/, batch/, misc/ など主要ディレクトリをすべて確認
   - 隠れたサブディレクトリも見落とさない
   - ファイル数が多い場合はGlobで効率的に検索

3. 担当観点に関連するファイルを特定し、すべて読む
   - 「たぶん問題ない」で飛ばさない
   - 類似ファイルも個別に確認

### 2. ベストプラクティスの調査（IMPORTANT）
問題を発見した場合、または問題が疑われる場合:

1. **deepwiki**で関連ライブラリのドキュメントを確認
   - 例: Drizzle ORMのN+1対策、Reactのメモ化ベストプラクティス等
   - resolve-library-id → query-docs の順で実行

2. **WebSearch**で業界標準のベストプラクティスを確認
   - 例: "OWASP timing attack prevention 2025"
   - 例: "React performance optimization best practices 2025"

3. 調査結果をissueファイルの「改善案」「追加情報」に反映

### 3. agent cliによる並行レビュー【必須・スキップ不可】

---
**このステップは必須です**

- `--skip-multimodel` オプションが**明示的に指定されていない限り**、以下のコマンドを**必ず実行**すること
- 実行しない場合、レビューは**不完全**とみなされる
- 「問題が少なそう」「時間がない」等の理由でのスキップは**禁止**

---

自分のレビューと並行して、agent cliで同じタスクを実行し、結果を突き合わせる:

1. **agent cliで同じ観点のレビューを実行**

   サブエージェントと同等の情報量でagent cliに指示する:

   ```bash
   agent -p "あなたは「{観点名}」の専門レビュアーです。

   ## コンテキスト
   - リポジトリ: {リポジトリパス}
   - PJルール: {CLAUDE.mdの内容}
   - コードベース構造: {ディレクトリ構造}

   ## あなたの担当観点
   {観点別の詳細指示（レビュー項目一覧）}

   ## 優先度判断基準
   {観点別の優先度基準}

   ## タスク
   1. コードベース全体を網羅的に確認
      - すべてのディレクトリとファイルを走査
      - 担当観点に関連するファイルをすべて読む
      - 「たぶん問題ない」で飛ばさない

   2. 問題を特定し、優先度を付与

   3. 発見した問題をJSON形式で出力:
   {
     \"issues\": [
       {
         \"title\": \"問題のタイトル（日本語）\",
         \"priority\": \"critical|major|minor|trivial\",
         \"files\": [\"ファイルパス:行番号\", ...],
         \"description\": \"問題の詳細説明\",
         \"suggestion\": \"改善案\",
         \"bestPractice\": \"参照したベストプラクティス（あれば）\"
       }
     ],
     \"checkedDirectories\": [\"確認したディレクトリ一覧\"],
     \"summary\": \"レビュー概要\"
   }

   ## 注意事項
   - 問題がない場合は issues: [] で出力
   - 推測ではなく、コードを実際に読んで判断
   - 優先度は厳格に判断（critの乱用禁止）
   - コードベースの一部だけを見て終わりにしない" \
     --model gpt-5.2-high \
     --output-format json
   ```

2. **結果を突き合わせ**

   | 状況 | 対応 |
   |------|------|
   | 両者が同じ問題を検出 | 高信頼度として採用 |
   | 自分のみ検出 | 妥当性を再確認、妥当なら採用 |
   | agent cliのみ検出 | 該当コードを確認、妥当なら採用 |
   | 優先度が異なる | 根拠を比較し適切な方を採用 |

3. **マージ結果を記録**
   issueファイルに以下を追記:
   ```markdown
   ## マルチモデル検証
   - Claude Code: 検出
   - agent cli (gpt-5.2-high): 検出/未検出
   - 信頼度: 高/中
   - 優先度差異: なし / あり（Claude Code={X}, agent cli={Y} → 採用: {Z}）
   ```

### 4. 問題の特定と記録
- 各問題に優先度（crit/high/mid/low）を付与
- 問題ごとにissueファイルを作成
- ベストプラクティス調査結果を含める
- マルチモデル検証結果を含める
```

## issueファイル形式

場所: `{MEMORY_DIR}/issues/{優先度}-{観点略語}-{日本語タイトル}.md`

```markdown
---
priority: {critical|major|minor|trivial}
category: {観点略語}
type: {bug|improvement|feature}
---

# {タイトル}

## 概要
{問題の簡潔な説明}

## 現状の問題点
{何が問題なのか、どこで発生しているか}
- 対象ファイル: {パス:行番号}
- 対象ファイル: {パス:行番号}

## 改善案
{どう改善すべきか}
- ベストプラクティス: {deepwiki/WebSearchで調査した内容}

## 期待される効果
{改善後のメリット}

## 対象範囲
{影響を受けるファイルや機能}

## 追加情報
- 参考: {調査したドキュメントURL等}
- 関連issue: {あれば}
```

## 注意事項

- 問題がない場合はissueファイルを作成しない
- 推測ではなく、コードを実際に読んで判断する
- 優先度は厳格に判断する（critの乱用禁止）
- **コードベースの一部だけを見て終わりにしない**
- **ベストプラクティス調査は問題発見時に必須**
