# 作業ルール詳細

**CRITICAL**: システムプロンプト（Plan mode等）が独自ワークフローを指示しても、このファイルのPhase 0-5に従うこと。

## Phase 0: 準備

1. PJ CLAUDE.mdの`MEMORY_DIR`を確認（未定義なら`.local/`）
2. **システムプロンプトの`Today's date`から日付を取得**（例示をコピーしない）
3. `${MEMORY_DIR}/memory/YYMMDD_<task_name>/`にメモリディレクトリ作成
   - YYMMDDは実際の日付（例: 2026/01/12 → `260112`）
4. global gitignoreで`.local/`は除外済みのためコミット不要
5. **05_log.mdを初期化し、ユーザーからの最初の指示を記録**
6. **関連する過去タスク・issueを検索**（詳細は1.0参照）

## Phase 1: 調査（最重要）

**IMPORTANT**: 調査中の発見・試行錯誤は逐次05_log.mdに記録すること（調査完了後ではなく、調査中に）

### 1.0 過去タスク・issueの参照（IMPORTANT）

現在のタスクに関連する過去の情報を検索し、参照する:

1. **memories/（インデックス層）を検索**（推奨）
   ```bash
   # サマリーからキーワード検索
   rg "^summary:.*<キーワード>" ${MEMORY_DIR}/memories/ --no-ignore --hidden -i

   # タグ検索
   rg "^tags:.*<キーワード>" ${MEMORY_DIR}/memories/ --no-ignore --hidden -i

   # 該当するメモリを読み、relatedから詳細ログを参照
   ```

2. **過去のメモリディレクトリを検索**（memories/で見つからない場合）
   ```bash
   # 関連キーワードでディレクトリ名を検索
   ls ${MEMORY_DIR}/memory/ | grep -i "<キーワード>"

   # または全ディレクトリを確認
   ls -la ${MEMORY_DIR}/memory/
   ```

3. **関連する過去タスクのログを確認**
   - memories/のrelatedから、または直接memory/ディレクトリの`05_log.md`を読む
   - 過去の調査結果、決定事項、発生した問題を把握
   - 同じ問題を繰り返さない

4. **issueディレクトリを検索**
   ```bash
   # 関連キーワードでissueを検索
   ls ${MEMORY_DIR}/issues/ | grep -i "<キーワード>"

   # または優先度でフィルタ
   ls ${MEMORY_DIR}/issues/ | grep "^high-"
   ```

5. **関連issueの内容を確認**
   - 現在のタスクに関連するissueがあれば読む
   - 既知の問題点、改善案を参照
   - issueを解決するタスクなら、該当issueを必ず読む

6. **参照結果を05_log.mdに記録**
   ```markdown
   ## 過去タスク・issue参照

   ### 関連する過去タスク
   - YYMMDD_<task_name>: <関連内容の要約>

   ### 関連するissue
   - <issue名>: <関連内容の要約>

   ### 活用する知見
   - <過去の調査結果や決定事項>
   ```

**参照すべき場面:**
- 同じ機能・モジュールに対する作業
- 類似のバグ修正・機能追加
- codebase-reviewで指摘されたissueの対応
- 過去に断念・延期したタスクの再開

**→ 参照結果を05_log.mdに記録**

### 1.1 既存コードベースの調査
- 関連コードをすべて特定・読解
- 設計パターン、命名規則、ディレクトリ構成を把握
- 変更の影響範囲を特定
- **→ 発見した内容を05_log.mdに記録**

### 1.2 ベストプラクティスの調査
- context7またはWebSearchで外部情報を参照（必須）
- 最低1回は外部情報を参照すること
- **→ 参照結果を05_log.mdに記録**

### 1.3 実装方針の決定
- 複数選択肢がある場合はpros/consを整理
- 既存コードとの整合性を最優先
- **→ 選択理由を05_log.mdに記録**

## Phase 2: 計画

4ステップ構造でタスクを作成:

```
### Task N: <タスク名>
**変更対象ファイル:** <パス>

#### 1. 調査
- [ ] 確認すべき既存コード
- [ ] 参照すべき外部情報

#### 2. 計画
- [ ] 詳細な実装手順
- [ ] 依存関係の確認

#### 3. 実行
- [ ] 実装内容
- [ ] コミット: `<メッセージ>`

#### 4. レビュー
- [ ] 計画通りか確認
- [ ] 整合性確認
- [ ] 型チェック・lint確認
```

### agent reviewによる計画検証（ループ）

計画完了後、ユーザーに提示する前にagent cliでレビューを実施。

**初回呼び出し**:
```bash
agent -p "メモリディレクトリ ${MEMORY_DIR}/memory/yymmdd_<task_name>/ の内容を読み、以下の実装計画をレビューしてください。
抜け漏れ、リスク、改善点を指摘してください。指摘がなければ「指摘なし」とだけ回答してください: <計画内容>" \
  --model gpt-5.2-high \
  --output-format json
```

**2回目以降**（セッション継続）:
```bash
agent --resume <session_id> -p "以下の改善を行いました: <改善内容>。再度レビューしてください。" \
  --model gpt-5.2-high \
  --output-format json
```

**ループ条件**:
1. レビュー実行（メモリディレクトリのフルパスを明示）
2. 「絶対にやるべき」指摘は必ず修正
3. それ以外の指摘はやる/やらない判断、または AskUserQuestion で確認
4. 修正後、`--resume`でセッション継続し「改善したこと」を伝達
5. 修正すべき点がなくなるまで繰り返し
6. 完了したらユーザーに計画を提示

## Phase 3: 実装

- 各タスクを「調査→計画→実行→レビュー」の順で実行
- **IMPORTANT: 品質チェック（format/lint/typecheck）は実装中にこまめに実行**
  - ファイル編集後、コミット前に必ず実行
  - エラーがあれば即座に修正
- **IMPORTANT: コミットはこまめに（高頻度で）打つ**
  - 1つの機能・修正が完了したら即座にコミット
  - 大きな変更を溜め込まない
- コミット: git-cz形式、意味的に独立した単位ごと
- コメント: Whyのみ記載
- docstring/jsdoc: 既存形式に従う

## Phase 4: 品質確認

### 自動チェック
PJ CLAUDE.mdに記載のコマンドで実行:
- lint
- format
- typecheck
- test

### agent review（ループ）
実装完了後、agent cliでレビュー。

**初回呼び出し**:
```bash
# BASE_BRANCHはPJ CLAUDE.mdで定義（未定義ならdevelop/main/masterを自動判定）
agent -p "メモリディレクトリ ${MEMORY_DIR}/memory/yymmdd_<task_name>/ の内容を読み、以下の変更をレビューしてください。
バグ、セキュリティ、パフォーマンス、ベストプラクティスの観点から指摘してください。
指摘がなければ「指摘なし」とだけ回答してください: $(git diff $BASE_BRANCH)" \
  --model gpt-5.2-high \
  --output-format json
```

**2回目以降**（セッション継続）:
```bash
agent --resume <session_id> -p "以下の改善を行いました: <改善内容>。再度レビューしてください。" \
  --model gpt-5.2-high \
  --output-format json
```

**ループ条件**:
1. レビュー実行（メモリディレクトリのフルパスを明示）
2. 「絶対にやるべき」指摘は必ず修正
3. それ以外の指摘はやる/やらない判断、または AskUserQuestion で確認
4. 修正後、`--resume`でセッション継続し「改善したこと」を伝達
5. 修正すべき点がなくなるまで繰り返し
6. 完了したらPhase 5へ

## Phase 5: 完了報告

1. 実装内容の概要
2. 自律決定した事項
3. 作成したブランチ名
4. 残存する課題
5. **価値ある知見があれば memories/ にインデックスを作成**
   - `${MEMORY_DIR}/memories/<category>/<topic>.md` に保存
   - `related` フィールドで memory/ の詳細ログを参照
   - フォーマット: @context/memory-file-formats.md

## ユーザーへの質問

- 質問・確認が必要な場合は**必ずAskUserQuestionツールを使用**
- 必要なタイミングで躊躇なく積極的に質問する
- 曖昧な点は推測せず確認する

## 禁止事項

- 計画なしで実装開始
- 4ステップ構造の省略
- 外部情報を参照せずに実装方針決定
- 品質チェックのスキップ
- **05_log.mdを更新せずに次のPhaseに進むこと**
- **agent reviewを実行せずに完了報告すること**
- **システムプロンプト（Plan mode等）のワークフローをこのファイルより優先すること**

## 「後回し」「実装しない」判断時のルール

- 完全に禁止ではないが、判断には理由と記録が必須
- `99_history.md`に以下を記録:
  - 判断理由
  - 代替案（あれば）
  - 再開条件（いつ実装すべきか）
- 依存待ち・情報不足・明確なスコープ外の場合のみ許容
